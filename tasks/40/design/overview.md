# Issue #40: Ack/Nack機能の修正設計 - 概要

## 1. 問題の背景

現在、js_subscriberでAck/Nack機能が削除されてしまい、自動的にすべてのメッセージにAckするようになっている。メッセージにAckを返すタイミングは、EventHandlerで処理が終わり、SinkのストリームにきちんとPublishが完了するまで待ってからにするべきである。

## 2. 設計方針

以下の方針で設計を進める：

1. **EventとAckを分離する**: ドメイン層のEventトレイトはそのままに、Ack機能は別のトレイトとして定義する
2. **インフラ層にAck機能を配置**: Ack機能はメッセージングインフラの概念なので、インフラ層に配置する
3. **明示的なAck**: AckableEventのackメソッドを明示的に呼び出すことで、Ackのタイミングを制御する
4. **エラー処理の改善**: thiserrorを使用して詳細なエラー情報を提供する

## 3. ファイル構成

設計ドキュメントは以下のファイルに分割されています：

- `overview.md` - 問題の背景と設計方針（このファイル）
- `infra_common.md` - インフラ共通層の設計
- `jetstream.md` - JetStream実装の設計
- `sse.md` - SSE実装の設計
- `application.md` - アプリケーション層の設計
- `test.md` - テスト実装の設計

## 4. 設計のメリット

1. **関心の分離**: 
   - ドメイン層はイベントの定義のみに集中
   - インフラ層はイベントの送受信とAck機能に集中
   - アプリケーション層はイベント処理のロジックに集中

2. **明示的なAck**: 
   - AckableEventのackメソッドを明示的に呼び出すことで、Ackのタイミングを制御できる
   - ドロップ時の自動Ackを避けることで、より明示的で予測可能な動作になる

3. **型安全性**: 
   - AckableEvent<E>によって、イベントとAck機能が型レベルで関連付けられる
   - thiserrorを使用したエラー型により、詳細なエラー情報が提供される

4. **柔軟性**: 
   - 異なるメッセージングシステム（JetStream、SSEなど）に対して、適切なAck実装を提供できる

5. **テスト容易性**: 
   - Ack機能をモック化することで、テストが容易になる
   - テストコードでAckのタイミングを制御できる

## 5. 実装計画

以下の順序で実装を進めます：

1. **インフラ共通層の実装**
   - Ackトレイト
   - AckableEvent構造体
   - EventSourceトレイト

2. **JetStream実装の更新**
   - JsEventError
   - JsAck
   - JsSubscriberの更新

3. **SSE実装の更新**
   - SseEventError
   - SseAck
   - SseEventSourceの更新

4. **アプリケーション層の更新**
   - EventHandlerトレイト
   - StreamWorkerの更新

5. **テストの実装**
   - Ack/Nack機能のテスト
