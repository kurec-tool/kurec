# ジョブについて

エンコードと文字起こしを合わせて「ジョブ」としてencoderプロセスが両方とも処理することで、エンコードと文字起こしの両方が同時に行われて過負荷になることを避ける。
ジョブは依存関係を定義出来て、0個以上の依存ジョブを指定出来る。循環依存は起動時にチェックしてエラーにする。
ジョブは「出力ファイル」を0個以上持つことが出来る。出力ファイルは設定により自動的にストレージに保存される。
mirakc管理の録画ファイルを削除するタイミングを管理するため、システムで特別にいくつかのジョブを自動的に追加する。

|ジョブ|依存ジョブ|説明|
|------|----------|----|
|元ファイル保存|なし|kurecで自動的に追加、httpでtsを取って来てstorageに保存|
|文字起こし|なし|kurecで自動的に追加、httpでtsを取って来て文字起こし＆メタデータを取得してmeilisearchに保存|
|エンコードジョブ|ユーザ指定+文字起こし|ユーザが指定したエンコードジョブ、エンコードが終わったらstorageに保存|
|削除|元ファイル保存+文字起こし+すべてのエンコードジョブ|全部終わった最後に実行されるジョブ。mirakcから元TSを削除|


## 録画ファイルの保存方法

設定で複数の **ストレージ** を定義できる
ストレージは（とりえあず）以下の3種類から選択できる

- ローカルストレージ
- S3ストレージ

ローカルストレージを複数定義することなども可能。
webまたはネットワーク共有デーモン(samba or webdav)を通して読むことを想定しているため、ユーザが直接データを見に来ることは無いものと仮定する

エンコード設定で設定ごとに保存先のストレージを選択できるので、

- エンコード結果はローカルストレージに保存
- 生TSはS3ストレージに保存

などの使い方が出来る

RustのNFSクライアントやsmbクライアントのライブラリがあるので、NFSストレージやCIFSストレージタイプを作っても良いかもしれない。
（それぞれOSレベルのマウントではなくクライアントとして書き込みに行く）

### ストレージタイプ: ローカルの場合

(ストレージルート)/{YYYY}/{MM}/{DD}/{mirakc record_id}/{encode configで設定したname}

YYYY/MM/DDは録画開始日時

### ストレージタイプ: S3の場合

TBW

### 内部データ構造

ある番組を録画すると「録画」として扱われる（＝mirakcのrecord_idが振られる）
「録画」をエンコードが正常に終了するとそれぞれのエンコード設定ごとに「エンコード済みデータ」として扱われる
（TSのままというのもある）

エンコード済みデータは映像データに限らず、文字起こしの字幕ファイルとかがあっても良い

録画はrecord_idをキーとした

