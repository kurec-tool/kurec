# KuRec Devinプレイブック

このプレイブックでは、KuRecプロジェクトでDevinを使用する際のルールと設定を定義しています。

## 言語設定

- ユーザーとの会話は日本語で会話してください。
- コードのコメントにも日本語を使ってください。
- Gitコミットメッセージは日本語で記述可能です。

## 作業開始準備

1. **ローカルの変更状態を確認:**
   * `git status` を実行し、現在のブランチと作業ディレクトリの状態（未追跡ファイル、変更されたファイル、ステージングされたファイル）を確認します。
   * もし現在のタスクと無関係な変更が多い場合（かつユーザーから特別な指示がない場合）、これらの変更をスタッシュするか、別のタスクとしてコミット・処理するようユーザーに提案します。

2. **`main` ブランチの状態を確認:**
   * `git fetch origin` を実行し、リモートリポジトリの最新情報を取得します。
   * `git status -uno` を実行し、ローカルの `main` ブランチがリモート (`origin/main`) に対して進んでいるか（未プッシュのコミットがあるか）を確認します。
   * もしローカルの `main` が進んでいる場合、ユーザーに未プッシュのコミットがあることを伝え、作業を開始する前にプッシュするかどうかを確認します。

3. **作業ブランチの確認と作成:**
   * 現在のブランチが `main` または他の保護されたブランチでないか確認します。
   * もし `main` ブランチにいる場合、またはユーザーから指示があった場合は、「Git ブランチルール」に従って新しい作業ブランチを作成します。

## Git ブランチルール

- ブランチ名を `devin/<type>/<description>` の形式で作成
- <type> は変更の種類を示す
  - feature: 新機能
  - fix: バグ修正
  - documentation: ドキュメントのみの変更
  - style: コードの意味に影響を与えない変更（空白、フォーマット、セミコロンの追加など）
  - refactor: バグ修正や機能追加のないコードの変更
  - test: テストの追加・修正
  - chore: ビルドプロセスやドキュメント生成などの補助ツールやライブラリの変更
- <description> は変更内容を簡潔に説明する英語の短い表現
  - 例: `add-post-feature`、`fix-login-bug` など

## Git コミット作成ルール

- 作業を分割した場合はその都度コミット
- コミットは小さく、1つの論理的な変更を含める
- コミットメッセージは日本語で記述可能
- コミットメッセージは下記の規約に従う
- コミットの前に作業の都合で作成した余計なファイルを削除しておく
- コミットの前に、各言語のフォーマッター・リンターを実行し、コードの整形や静的解析を行う
- ステージングするファイルは `git status` コマンド、`git diff` コマンドを使用して、変更内容を確認し、必要なファイルを選択
- ステージング漏れのないよう、自分が変更したと思っているファイルだけでなく `git status` コマンドなどで変更のあったファイルを漏れなく含める

**避けるべき操作**:
- 対話的なgitコマンド（-iフラグ）の使用
- リモートリポジトリへの直接プッシュ
- mainブランチへのコミット
- git設定の変更
- git管理が不要であることが分かっているファイルは含めない
- 特にクレデンシャルなどの機密情報は絶対に含めない

## コミットメッセージ規約

### 基本構造
```
<type>(<scope>): <subject>

<body>

<footer>

# プロンプト履歴
<prompt_history>
```

### 各要素の説明

#### Type
- feature: 新機能
- fix: バグ修正
- docs: ドキュメントのみの変更
- style: コードの意味に影響を与えない変更（空白、フォーマット、セミコロンの追加など）
- refactor: バグ修正や機能追加のないコードの変更
- test: テストの追加・修正
- chore: ビルドプロセスやドキュメント生成などの補助ツールやライブラリの変更

#### Scope
- 変更の影響範囲を示す（例: `domain::user`, `infra::jetstream`, `app::worker` など、関連するモジュールやコンポーネント名）
- 複数のスコープがある場合はカンマで区切る
- 全体的な変更の場合は省略可能

#### Subject
- 変更内容を簡潔に要約

#### Body
- 変更の詳細な説明
- 改行して複数行で記述可能
- なぜその変更が必要だったのかの背景も含める
- 72文字で改行

#### Footer
- 必要に応じて関連するIssue番号などを記載（例: `Closes #123`, `Refs #456`）

#### Prompt History
- ユーザーが指示したプロンプトの履歴を記載
- プロンプトに関連する追加のコンテキスト情報も含める

## GitHub の利用方法

### Issue の確認方法

Devinへの指示をIssueで行う場合があります。例：「Issue #1 の内容を見て対応してください」
その場合は `gh` コマンドを使って、Issueの内容を確認します。

```bash
$ gh issue view <issue_number>
```

### プルリクエスト作成規約

- 作業結果は必ずプルリクエストとして提出すること
- プルリクエストは、ベースブランチを `main` に固定
- タイトルとボディは日本語で記述
- タイトルは下記
  - ブランチに含まれるコミット内容を簡潔に要約
  - フォーマット: `変更内容の要約`
  - 例：`ドキュメントレビュー承認機能の追加`
- ボディは下記
  - `git log --oneline <base_branch>..HEAD` などを参考に、ブランチに含まれる主要なコミットを抽出し、Markdownの箇条書き形式で要約する。
  - 変更の背景や目的、解決したIssueなどを簡潔に記述する。
  - 必要に応じて、テスト実行結果や動作確認手順、スクリーンショットなどを追記する。

### プルリクエストの作成方法

`gh pr create` コマンドを使用して、プルリクエストを作成します。

```bash
$ gh pr create --base main --title "変更内容の要約" --body "変更の背景や目的、解決したIssueなどを簡潔に記述"
```

### レビュー依頼時の注意点

- 特に確認してほしい点を明記
- コードの複雑な部分には補足説明を追加

## コーディング規約（言語非依存）

- 作業記録のような意味をなさないコメントは絶対に付けない
- 読めば分かるような単純なコメントは絶対に付けない

## ドキュメント ルール

- **原則:** コードとドキュメントの一貫性を保つため、コード変更に伴いドキュメントに差異が生じた場合は、速やかにドキュメントを更新してください。
- **対象:** 主に `docs/` ディレクトリ以下の関連ファイル、および必要に応じて `README.md` などを更新対象とします。
- **タイミング:** 機能追加・変更、API仕様変更、アーキテクチャ変更、重要なバグ修正など、ドキュメントの内容に影響を与える変更を行った際に更新します。
- **依頼方法:** Devinにドキュメント更新を依頼する場合は、変更内容と関連するドキュメントファイルを具体的に指示してください。

## Rust 作業時のルール

- 設計時は docs/design/rust/design.md を参照
- ワーカーを追加する時は docs/design/rust/stream_worker.md と docs/design/rust/shutdown.md を参照
- クレート追加時は docs/design/rust/crate_naming.md を参照
- テスト作成時は docs/design/rust/testing.md を参照

また、全般的な注意事項として以下を参照すること

- docs/design/rust/naming.md

## 振り返り

作業終了時に振り返りを行うことで、次回の作業に活かします。

- ドキュメントに追加すべきことはないか
- ルールに従っていなかったことはないか
- ルールに従っていたが、改善の余地があることはないか
- 次に行うタスクとしてユーザに提案出来ることはないか
